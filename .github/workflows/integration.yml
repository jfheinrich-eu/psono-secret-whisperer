name: Integration-Test
permissions:
  contents: read
  pull-requests: write
  statuses: write
  actions: read

on:
  push:
    branches-ignore:
      - main
  pull_request:
    branches:
      - main
      - develop

jobs:
  integration-test:
    name: Integration-Test
    if: ${{ github.actor != 'dependabot[bot]' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Self test
        if: ${{ github.actor != 'dependabot[bot]' }}
        id: selftest
        # Put your action repo here
        uses: ./
        with:
          ci_api_key_id: ${{ secrets.PSONO_API_KEY_ID }}
          ci_api_secret_key_hex: ${{ secrets.PSONO_API_SECRET_KEY_HEX }}
          ci_server_url: ${{ vars.PSONO_SERVER_URL }}
          secret_id: ${{ secrets.PSONO_GITHUB_REGISTRY_ID }}
          secret_type: 'env'
          secret_fields: CI_REGISTRY,CI_REGISTRY_USER
          mask_secrets: CI_REGISTRY_USER

      - name: Check outputs and write summary
        id: check_outputs
        if: always()
        run: |
          result1="success"
          result2="success"
          echo "## Output Check Results" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.selftest.outputs.secret1 }}" != "ghcr.io" ]; then
            echo "- ❌ secret1 mismatch: got '${{ steps.selftest.outputs.secret1 }}'" >> $GITHUB_STEP_SUMMARY
            result1="fail"
          else
            echo "- ✅ secret1 is correct" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.selftest.outputs.secret2 }}" != "jfheinrich" ]; then
            echo "- ❌ secret2 mismatch: got '${{ steps.selftest.outputs.secret2 }}'" >> $GITHUB_STEP_SUMMARY
            result2="fail"
          else
            echo "- ✅ secret2 is correct" >> $GITHUB_STEP_SUMMARY
          fi
          # Combine results
          if [ "$result1" = "fail" ] || [ "$result2" = "fail" ]; then
            echo "status=fail" >> "$GITHUB_OUTPUT"
          else
            echo "status=success" >> "$GITHUB_OUTPUT"
          fi
          
      - name: Fail if check failed
        if: steps.check_outputs.outputs.status == 'fail'
        run: |
          echo "Output check failed!"
          exit 1
      - name: Success if check successful
        if: steps.check_outputs.outputs.status == 'success'
        run: |
          echo "Output check successful!"
          exit 0
          
