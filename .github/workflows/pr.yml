name: Release Info
permissions:
  contents: read
  pull-requests: write

on:
  pull_request:
    types: [labeled, unlabeled, opened, edited, reopened, synchronize, ready_for_review]
    branches:
      - develop

jobs:
  generate-pr-description:
    name: Generate the description on the pull request
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate PR Description from Conventional Commits
        id: pr-description
        run: |
          # Get all commits in the PR
          commits=$(git log --pretty=format:"%H|%s" origin/${{ github.event.pull_request.base.ref }}..${{ github.event.pull_request.head.sha }})

          # Initialize categories
          features=""
          fixes=""
          docs=""
          chore=""
          deps=""
          other=""

          # Process each commit
          while IFS='|' read -r hash message; do
            if [[ $message =~ ^feat(\(.+\))?: ]]; then
              features="$features- $message\n"
            elif [[ $message =~ ^fix(\(.+\))?: ]]; then
              fixes="$fixes- $message\n"
            elif [[ $message =~ ^docs(\(.+\))?: ]]; then
              docs="$docs- $message\n"
            elif [[ $message =~ ^chore(\(.+\))?: ]]; then
              chore="$chore- $message\n"
            elif [[ $message =~ ^(build|deps)(\(.+\))?: ]]; then
              deps="$deps- $message\n"
            else
              other="$other- $message\n"
            fi
          done <<< "$commits"

          # Build changelog
          changelog=""

          if [[ -n "$features" ]]; then
            changelog="$changelog## ðŸš€ Features\n$features\n"
          fi

          if [[ -n "$fixes" ]]; then
            changelog="$changelog## ðŸ› Bug Fixes\n$fixes\n"
          fi

          if [[ -n "$docs" ]]; then
            changelog="$changelog## ðŸ“š Documentation\n$docs\n"
          fi

          if [[ -n "$deps" ]]; then
            changelog="$changelog## â¬†ï¸ Dependencies\n$deps\n"
          fi

          if [[ -n "$chore" ]]; then
            changelog="$changelog## ðŸ§¹ Chore\n$chore\n"
          fi

          if [[ -n "$other" ]]; then
            changelog="$changelog## ðŸ”§ Other Changes\n$other\n"
          fi

          # Set output with proper escaping
          {
            echo "changelog<<EOF"
            echo -e "$changelog"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Update pull request body
        uses: riskledger/update-pr-description@v2
        with:
          body: |
            # Task

            ${{ github.event.pull_request.title }}

            # Description

            <!--- START AUTOGENERATED NOTES --->
            ${{ steps.pr-description.outputs.changelog }}
            <!--- END AUTOGENERATED NOTES --->

            # Demo

            # Checklist

            - [ ] I have performed a self-review of my own code
            - [ ] I have added tests to cover my changes
          token: ${{ secrets.GITHUB_TOKEN }}

  check-pr:
    if: ${{ github.actor != 'dependabot[bot]' }}
    needs: generate-pr-description
    name: Validate Release Label and Notes
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - id: setup-secrets
        name: Setup secrets
        env:
          PSONO_CI_API_KEY_ID: ${{ secrets.PSONO_API_KEY_ID }}
          PSONO_CI_API_SECRET_KEY_HEX: ${{ secrets.PSONO_API_SECRET_KEY_HEX }}
          PSONO_CI_SERVER_URL: ${{ vars.PSONO_SERVER_URL }}
          PSONO_GITHUB_TOKEN_ID: ${{ secrets.PSONO_GITHUB_CLI_TOKEN }}
        run: |
          sudo apt update >/dev/null && sudo apt install -y curl >/dev/null
          curl https://get.psono.com/psono/psono-ci/x86_64-linux/psonoci --output psonoci >/dev/null && chmod +x psonoci
          ci_psono_registry_github_token="$(./psonoci secret get ${PSONO_GITHUB_TOKEN_ID} password)"
          echo "::add-mask::$ci_psono_registry_github_token"
          echo "ci_registry_github_token=$ci_psono_registry_github_token" >> "$GITHUB_OUTPUT"

      - uses: actions/checkout@v4

      - uses: jefflinse/pr-semver-bump@v1.7.3
        name: Validate Pull Request Metadata
        with:
          mode: validate
          repo-token: ${{ steps.setup-secrets.outputs.ci_registry_github_token }}
          major-label: major release
          minor-label: minor release
          patch-label: patch release
          noop-labels: |
            documentation change
            dependencies
            skip-release
          require-release-notes: true
          release-notes-prefix: '<!--- START AUTOGENERATED NOTES --->'
          release-notes-suffix: '<!--- END AUTOGENERATED NOTES --->'
          with-v: false
          base-branch: false
